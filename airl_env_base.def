Bootstrap: docker
From: nvidia/cuda:10.0-cudnn7-devel-ubuntu18.04

%labels
    Author a.cully@imperial.ac.uk
    Version v0.0.1


%environment
	export LD_LIBRARY_PATH="/workspace/lib:$LD_LIBRARY_PATH"
        export PATH="/workspace/bin:$PATH"

%files
	resources/etc /workspace/tmp/etc
	resources/bin /workspace/bin
	resources/ssrc /workspace/include/ssrc
	resources/.vnc /workspace/tmp/.vnc


%post
        export LD_LIBRARY_PATH="/workspace/lib:$LD_LIBRARY_PATH"
	## INSTALLING DEPENDENCIES
	apt-get update
	apt-get install --no-install-recommends -y software-properties-common
	apt-get update

 	DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
	libboost-dev \
	libboost-test-dev \
	libboost-filesystem-dev \
	libboost-program-options-dev \
	libboost-graph-parallel-dev \
	libboost-thread-dev \
	libboost-regex-dev \
	python3.6 \
	g++ \
	libeigen3-dev \
	python3-simplejson \
	python3-setuptools \
	libboost-mpi-dev \
	openmpi-common \
	openmpi-bin \
	libgoogle-perftools-dev \
	git \
	wget \
	libtbb-dev \
	build-essential \
	cmake \
	pkg-config \
	libassimp-dev \
	libccd-dev \
	libfcl-dev \
	libxi-dev \
	libxmu-dev \
	freeglut3-dev \
	libbullet-dev \
	libode-dev \
	libtinyxml2-dev \
	liburdfdom-dev \
	libglfw3-dev \
	libopenal-dev \
	libjpeg-dev \
	libpng-dev \
	libgl1-mesa-dri \
	libxtst6 \
        libxv1 \
	net-tools \
	x11-xkb-utils \
	xauth \
	openbox \
	sudo \
	xterm \
	less \
	vim \
	emacs

	ln -s /usr/bin/python3 /usr/bin/python

	mkdir /git

	## INSTALLING DART
	cd /git
	git clone git://github.com/dartsim/dart.git
	cd dart
	git checkout release-6.9
	mkdir build
	cd build
	if [ -z "${MYOPT}" ]; then #if SINGULARITYENV_MYOPT="SIMD" singularity build ... is defined (regardless of the value), use the SIMD
	  echo "NOT USING SIMD"
	  cmake -DCMAKE_INSTALL_PREFIX:PATH=/workspace ..	
	else
	  echo "USING SIMD INSTRUCTIONS"
	  cmake -DDART_ENABLE_SIMD=ON -DCMAKE_INSTALL_PREFIX:PATH=/workspace ..
	fi

	

	make -j install

	## INSTALLING HEXAPOD_COMMON
	cd /git
	git clone https://github.com/resibots/hexapod_common.git
	cd hexapod_common/hexapod_controller
	./waf configure --prefix /workspace
	./waf install


	## Installing Magnum
	# installation of Corrade
	cd  /git
	git clone https://github.com/mosra/corrade.git
	cd corrade
	mkdir build && cd build
	cmake -DCMAKE_INSTALL_PREFIX:PATH=/workspace ..
	make -j
	make install
	
	# installation of Magnum
	cd /git
	git clone https://github.com/mosra/magnum.git
	cd magnum
	mkdir build && cd build
	cmake -DCMAKE_INSTALL_PREFIX:PATH=/workspace -DWITH_AUDIO=ON -DWITH_DEBUGTOOLS=ON -DWITH_GL=ON -DWITH_MESHTOOLS=ON -DWITH_PRIMITIVES=ON -DWITH_SCENEGRAPH=ON -DWITH_SHADERS=ON -DWITH_TEXT=ON -DWITH_TEXTURETOOLS=ON -DWITH_TRADE=ON -DWITH_GLFWAPPLICATION=ON -DWITH_WINDOWLESSGLXAPPLICATION=ON -DWITH_OPENGLTESTER=ON -DWITH_ANYAUDIOIMPORTER=ON -DWITH_ANYIMAGECONVERTER=ON -DWITH_ANYIMAGEIMPORTER=ON -DWITH_ANYSCENEIMPORTER=ON -DWITH_MAGNUMFONT=ON -DWITH_OBJIMPORTER=ON -DWITH_TGAIMPORTER=ON -DWITH_WAVAUDIOIMPORTER=ON .. 

	make -j
	make install

	# installation of Magnum Plugins
	cd /git
	git clone https://github.com/mosra/magnum-plugins.git
	cd magnum-plugins
	mkdir build && cd build
	cmake -DCMAKE_INSTALL_PREFIX:PATH=/workspace -DWITH_ASSIMPIMPORTER=ON -DWITH_DDSIMPORTER=ON -DWITH_JPEGIMPORTER=ON -DWITH_OPENGEXIMPORTER=ON -DWITH_PNGIMPORTER=ON -DWITH_TINYGLTFIMPORTER=ON .. 
	make -j
	make install

	# installation of Magnum DART Integration (DART needs to be installed)
	cd /git
	git clone https://github.com/mosra/magnum-integration.git
	cd magnum-integration
	mkdir build && cd build
	cmake -DCMAKE_INSTALL_PREFIX:PATH=/workspace -DWITH_DART=ON ..
	make -j
	make install

	#removing previous folders
	cd /git
	rm -rf ./magnum-integration
	rm -rf ./magnum-plugins
	rm -rf ./magnum
	rm -rf ./corrade


	## INSTALLING ROBOT_DART
	cd /git
	git clone https://github.com/resibots/robot_dart.git
	cd robot_dart
	./waf configure --prefix /workspace --dart /workspace --shared --controller /workspace --magnum_install_dir  /workspace --magnum_integration_install_dir /workspace --magnum_plugins_install_dir /workspace --corrade_install_dir /workspace
	./waf
	./waf install
	
	## INSTALLING SFERES2
	cd /git
	git clone https://github.com/sferes2/sferes2.git
	cd sferes2
	git checkout qd_py3
	#sed -i 's/-O3/-O3 -march=native -g -faligned-new '/g ./wscript	
	./waf configure --kdtree /workspace/include
	./waf build

	## INSTALLING VISU_SERVER
	
	cd /git

	wget https://svwh.dl.sourceforge.net/project/turbovnc/2.2.3/turbovnc_2.2.3_amd64.deb
        wget https://svwh.dl.sourceforge.net/project/libjpeg-turbo/2.0.3/libjpeg-turbo-official_2.0.3_amd64.deb
        wget https://svwh.dl.sourceforge.net/project/virtualgl/2.6.3/virtualgl_2.6.3_amd64.deb
        dpkg -i *.deb
        rm -f /tmp/*.deb
        sed -i 's/$host:/unix:/g' /opt/TurboVNC/bin/vncserver

	
	      
	mv /workspace/tmp/etc/X11/* /etc/X11/
	mv /workspace/tmp/etc/skel/.xinitrc /etc/skel/
	mv /workspace/tmp/etc/xdg/openbox/* /etc/xdg/openbox/
	mv /workspace/tmp/etc/turbovncserver.conf /etc/turbovncserver.conf
	mv /workspace/tmp/.vnc /opt/.vnc

	rm -r /workspace/tmp

	git clone --branch v0.9.0 https://github.com/novnc/websockify.git /opt/websockify
	cd /opt/websockify
	python3 setup.py install

	git clone https://github.com/kanaka/noVNC.git /opt/noVNC
	cd /opt/noVNC
	ln -s vnc_lite.html index.html


	## Cleaning
	rm -rf /var/lib/apt/lists/*
	rm -f /usr/share/applications/x11vnc.desktop


%runscript
	cd /git/robot_dart/
	visu_server.sh &
	pid=$!
	ps
	echo $pid
	./build/arm
	ps
	kill $pid


%test
	export LD_LIBRARY_PATH="/workspace/lib:$LD_LIBRARY_PATH"
	cd /git/robot_dart/
	./build/hexapod_plain


%help
This container contains all the libraries and tools usually used in the Adaptive and Intelligent Robotics Lab. 